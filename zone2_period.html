

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¾ãƒ¼ãƒ³2 ã‚¹ãƒãƒ¼ãƒˆè¾²æ¥­ã‚·ã‚¹ãƒ†ãƒ ï¼šæœŸé–“åˆ¥ã‚°ãƒ©ãƒ•è¡¨ç¤º</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 2em; }
    h1, h2 { color: #333; }
    #controls { margin-bottom: 2em; }
    label { margin-right: 1em; }
    input[type="date"] { font-size: 1em; margin-right: 1em; }
    button { font-size: 1em; padding: 0.4em 1em; }
    .chart-wrapper {
      overflow-x: auto;
      padding-bottom: 1em;
    }
    canvas {
      min-width: 1000px;
      max-width: none;
      height: auto;
      background: white;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #weatherBox { margin-bottom: 2em; }
    #weatherTable { width: 100%; text-align: center; border-collapse: collapse; }
    #weatherTable th, #weatherTable td { border: 1px solid #ccc; padding: 0.5em; }
  </style>
</head>
<body>

<h1>ğŸ“ˆ ã‚¾ãƒ¼ãƒ³2ã€€è¨ˆæ¸¬å€¤ï¼šæœŸé–“åˆ¥ã‚°ãƒ©ãƒ•è¡¨ç¤º</h1>

<img src="å›³/map2.png" alt="åœƒå ´ãƒãƒƒãƒ—" style="max-width: 10%; height: auto;">

<div id="controls">
  <label>é–‹å§‹æ—¥ï¼š<input type="date" id="startDate"></label>
  <label>çµ‚äº†æ—¥ï¼š<input type="date" id="endDate"></label>
  <button onclick="updateRangeGraphs()">ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º</button>
</div>

<h2>ğŸŒ¤ æŒ‡å®šæœŸé–“ã®å¤©æ°—ï¼ˆç¦å±±å¸‚ï¼‰</h2>
<div id="weatherBox" style="display:none;">
  <div id="weatherLoading">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã§ã™...</div>
  <table id="weatherTable"></table>
</div>

<h2>ğŸŒ¡ æ¸©åº¦ï¼ˆå·¦ï¼‰ãƒ»æ¹¿åº¦ï¼ˆå³ï¼‰</h2>
â€»æ°—æ¸©ã§ã¯ãªãï¼ŒBOXå†…ã®å®Ÿæ¸¬æ¸©åº¦ã§ã™ã€‚
<div class="chart-wrapper"><canvas id="tempHumChart"></canvas></div>

<h2>ğŸ’§ åœŸå£Œæ°´åˆ†é‡</h2>
<div class="chart-wrapper"><canvas id="moistureChart"></canvas></div>

<h2>ğŸ’¡ å…‰é‡ [lux]</h2>
â€»æ¸¬å®šã§ãã‚‹æœ€å¤§å€¤ã¯ç´„50,000[lux]ã§ã™.<br>
å…‰é‡[lux]ã®ç›®å®‰ã¯<a href=lux.html>ã“ã¡ã‚‰</a>ã‹ã‚‰<br>
<div class="chart-wrapper"><canvas id="lightChart"></canvas></div>

<script>
const apiUrlSensor = "https://script.google.com/macros/s/AKfycby1NV3dFQg1LGrdAI608vADc-npvcF322NHSDKQQKfm_TmzOCcJNmXM71DTiLhNOVnB/exec?mode=sensor";
const weatherDescriptions = {
  0: "â˜€ å¿«æ™´", 1: "â˜€ æ™´ã‚Œ", 2: "ğŸŒ¤ ä¸€éƒ¨æ›‡ã‚Š", 3: "â˜ æ›‡ã‚Š",
  45: "ğŸŒ« éœ§", 51: "ğŸŒ§ å¼±ã„éœ§é›¨", 61: "ğŸŒ§ å¼±ã„é›¨", 63: "ğŸŒ§ ä¸­ç¨‹åº¦ã®é›¨",
  65: "ğŸŒ§ å¼·ã„é›¨", 80: "ğŸŒ¦ ã«ã‚ã‹é›¨", 95: "â›ˆ é›·é›¨"
};

let allData = [];

fetch(apiUrlSensor)
  .then(res => res.json())
  .then(data => {
    allData = data;
  });

let tempHumChart, moistureChart, lightChart;

function updateRangeGraphs() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  if (!start || !end || start > end) {
    alert("æ­£ã—ã„æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  updateWeatherTable(start, end);

  const filtered = allData.filter(row => {
    const raw = row["æ—¥æ™‚"] || row["æ—¥ä»˜"];
    if (!raw) return false;
    const d = new Date(raw);
    const ymd = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2, '0') + "-" + String(d.getDate()).padStart(2, '0');
    return ymd >= start && ymd <= end;
  });

  if (filtered.length === 0) {
    alert("æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  const labels = formatTimeLabels(filtered);
  const temperature = filtered.map(row => parseFloat(row["æ¸©åº¦[â„ƒ]"]));
  const humidity = filtered.map(row => parseFloat(row["æ¹¿åº¦[%]"]));
  const moisture = filtered.map(row => parseFloat(row["æ°´åˆ†é‡"]));
  const light = filtered.map(row => parseFloat(row["å…‰é‡[lux]"]));

  if (tempHumChart) tempHumChart.destroy();
  const ctx1 = document.getElementById("tempHumChart").getContext("2d");
  tempHumChart = new Chart(ctx1, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        { label: "æ¸©åº¦[â„ƒ]", data: temperature, borderColor: "red", yAxisID: "y", tension: 0.3, fill: false },
        { label: "æ¹¿åº¦[%]", data: humidity, borderColor: "blue", yAxisID: "y2", tension: 0.3, fill: false }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: "index", intersect: false },
      stacked: false,
      scales: {
        x: {
          ticks: { autoSkip: true, maxRotation: 45, minRotation: 20 }
        },
        y: {
          type: "linear",
          position: "left",
          title: { display: true, text: "æ¸©åº¦[â„ƒ]" }
        },
        y2: {
          type: "linear",
          position: "right",
          title: { display: true, text: "æ¹¿åº¦[%]" },
          grid: { drawOnChartArea: false }
        }
      }
    }
  });

  if (moistureChart) moistureChart.destroy();
  const ctx2 = document.getElementById("moistureChart").getContext("2d");
  moistureChart = new Chart(ctx2, {
    type: "line",
    data: {
      labels: labels,
      datasets: [{ label: "åœŸå£Œæ°´åˆ†é‡", data: moisture, borderColor: "green", borderWidth: 2, tension: 0.3, fill: false }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          ticks: { autoSkip: true, maxRotation: 45, minRotation: 20 }
        },
        y: {
          min: 0,
          max: 1000,
          title: { display: true, text: "æ°´åˆ†é‡" }
        }
      }
    }
  });

  if (lightChart) lightChart.destroy();
  const ctx3 = document.getElementById("lightChart").getContext("2d");
  lightChart = new Chart(ctx3, {
    type: "line",
    data: {
      labels: labels,
      datasets: [{ label: "å…‰é‡ [lux]", data: light, borderColor: "orange", borderWidth: 2, tension: 0.3, fill: false }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          ticks: { autoSkip: true, maxRotation: 45, minRotation: 20 }
        },
        y: {
          min: 0,
          max: 50000,
          title: { display: true, text: "å…‰é‡ [lux]" }
        }
      }
    }
  });
}

function formatTimeLabels(data) {
  return data.map(row => {
    const raw = row["æ—¥æ™‚"] || row["æ—¥ä»˜"] + " " + row["æ™‚é–“"];
    const dt = new Date(raw);
    const month = dt.getMonth() + 1;
    const date = dt.getDate();
    const hour = dt.getHours().toString().padStart(2, '0');
    const min = dt.getMinutes().toString().padStart(2, '0');
    return `${month}/${date} ${hour}:${min}`;
  });
}

function updateWeatherTable(start, end) {
  document.getElementById("weatherLoading").style.display = "block";
  const api = `https://api.open-meteo.com/v1/forecast?latitude=34.4859&longitude=133.3625&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo&start_date=${start}&end_date=${end}`;
  fetch(api)
    .then(res => res.json())
    .then(data => {
      const dates = data.daily.time;
      const weekdays = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
      const dateLabels = dates.map(d => {
        const dt = new Date(d);
        return `${d}ï¼ˆ${weekdays[dt.getDay()]})`;
      });
      const weather = data.daily.weathercode.map(code => weatherDescriptions[code] || "ä¸æ˜");
      const maxT = data.daily.temperature_2m_max;
      const minT = data.daily.temperature_2m_min;
      const rain = data.daily.precipitation_probability_max;

      const table = document.getElementById("weatherTable");
      table.innerHTML = `
        <tr><th>é …ç›®ï¼¼æ—¥ä»˜</th>${dateLabels.map(d => `<th>${d}</th>`).join('')}</tr>
        <tr><td>å¤©æ°—</td>${weather.map(w => `<td>${w}</td>`).join('')}</tr>
        <tr><td>æœ€é«˜æ°—æ¸©</td>${maxT.map(t => `<td>${t}â„ƒ</td>`).join('')}</tr>
        <tr><td>æœ€ä½æ°—æ¸©</td>${minT.map(t => `<td>${t}â„ƒ</td>`).join('')}</tr>
        <tr><td>é™æ°´ç¢ºç‡</td>${rain.map(p => `<td>${p}%</td>`).join('')}</tr>
      `;
      document.getElementById("weatherBox").style.display = "block";
      document.getElementById("weatherLoading").style.display = "none";
    })
    .catch(err => {
      document.getElementById("weatherLoading").textContent = "å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
      console.error(err);
    });
}
</script>
</body>
</html>
